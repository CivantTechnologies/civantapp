-- Rollback: FR DECP end-date enrichment (run date 2026-02-22)
-- Scope: exactly the rows currently tagged with framework_evidence.fr_decp_match_score
-- Tenant: civant_default
-- Notes:
--   - Reverts end_date only when it was set by DECP enrichment.
--   - Reverts duration_months to NULL only when duration source is DECP.
--   - Preserves other evidence keys.

begin;

create temp table tmp_fr_decp_rollback_targets (
  tenant_id text not null,
  award_canonical_id text not null,
  decp_id text,
  decp_match_score integer,
  primary key (tenant_id, award_canonical_id)
);

insert into tmp_fr_decp_rollback_targets (
  tenant_id,
  award_canonical_id,
  decp_id,
  decp_match_score
)
values
('civant_default','BOAMP_FR:20-101761','2020V9D0039AI',86),
('civant_default','BOAMP_FR:20-104309','2020V0D0011UV',86),
('civant_default','BOAMP_FR:20-115773','2020001',86),
('civant_default','BOAMP_FR:20-125697','2020013',86),
('civant_default','BOAMP_FR:20-14003','2014003',100),
('civant_default','BOAMP_FR:20-14218','2020M1902',83),
('civant_default','BOAMP_FR:20-18401','2018/4-01',100),
('civant_default','BOAMP_FR:20-2000','202000',100),
('civant_default','BOAMP_FR:20-20018','2020-018',100),
('civant_default','BOAMP_FR:20-20034','2020/034',100),
('civant_default','BOAMP_FR:20-2006','202006',100),
('civant_default','BOAMP_FR:20-2015','2020-15',100),
('civant_default','BOAMP_FR:20-20245','2020245',100),
('civant_default','BOAMP_FR:20-20508','2020508',100),
('civant_default','BOAMP_FR:20-20644','2020644',100),
('civant_default','BOAMP_FR:20-20797','2020797',100),
('civant_default','BOAMP_FR:20-20917','2020917',100),
('civant_default','BOAMP_FR:20-21024','2021024',100),
('civant_default','BOAMP_FR:20-2103','2021-03',100),
('civant_default','BOAMP_FR:20-21044','2021044',100),
('civant_default','BOAMP_FR:20-21048','2021_048',100),
('civant_default','BOAMP_FR:20-21097','2021097',100),
('civant_default','BOAMP_FR:20-21103','2021103',100),
('civant_default','BOAMP_FR:20-21115','2021115',100),
('civant_default','BOAMP_FR:20-21145','2021145',100),
('civant_default','BOAMP_FR:20-21147','2021147',100),
('civant_default','BOAMP_FR:20-2116','2021-16',100),
('civant_default','BOAMP_FR:20-21174','2021174',100),
('civant_default','BOAMP_FR:20-21181','2021181',100),
('civant_default','BOAMP_FR:20-21246','2021246',100),
('civant_default','BOAMP_FR:20-21280','2021280',100),
('civant_default','BOAMP_FR:20-21340','2021340',100),
('civant_default','BOAMP_FR:20-21884','2021884',100),
('civant_default','BOAMP_FR:20-21929','2020SUNUM00002',83),
('civant_default','BOAMP_FR:20-21931','2021931',100),
('civant_default','BOAMP_FR:20-22','2022',100),
('civant_default','BOAMP_FR:20-22000','2022000',100),
('civant_default','BOAMP_FR:20-22009','2022-009',100),
('civant_default','BOAMP_FR:20-22034','2022034',100),
('civant_default','BOAMP_FR:20-2205','2022-05',100),
('civant_default','BOAMP_FR:20-22052','2022052',100),
('civant_default','BOAMP_FR:20-22058','2022058',100),
('civant_default','BOAMP_FR:20-2207','2022-07',100),
('civant_default','BOAMP_FR:20-22086','2022086',100),
('civant_default','BOAMP_FR:20-22089','2022089',100),
('civant_default','BOAMP_FR:20-22105','2022105',100),
('civant_default','BOAMP_FR:20-22106','2022106',100),
('civant_default','BOAMP_FR:20-2211','2022_11',100),
('civant_default','BOAMP_FR:20-22122','2022-122',100),
('civant_default','BOAMP_FR:20-22145','2022145',100),
('civant_default','BOAMP_FR:20-22170','2022-170',100),
('civant_default','BOAMP_FR:20-22176','2022176',100),
('civant_default','BOAMP_FR:20-22179','2022179',100),
('civant_default','BOAMP_FR:20-22200','2022200',100),
('civant_default','BOAMP_FR:20-22302','2022302',100),
('civant_default','BOAMP_FR:20-22465','2022465',100),
('civant_default','BOAMP_FR:20-22516','2022516',100),
('civant_default','BOAMP_FR:20-22562','2022562',100),
('civant_default','BOAMP_FR:20-22564','2022564',100),
('civant_default','BOAMP_FR:20-226','20226',100),
('civant_default','BOAMP_FR:20-2274','202274',100),
('civant_default','BOAMP_FR:20-2299','202299',100),
('civant_default','BOAMP_FR:20-230','20230',100),
('civant_default','BOAMP_FR:20-23021','2023-02-1',100),
('civant_default','BOAMP_FR:20-23033','2023_033',100),
('civant_default','BOAMP_FR:20-23047','2023047',100),
('civant_default','BOAMP_FR:20-23056','2023056',100),
('civant_default','BOAMP_FR:20-23081','2023081',100),
('civant_default','BOAMP_FR:20-23120','2023-120',100),
('civant_default','BOAMP_FR:20-23128','2023-128',100),
('civant_default','BOAMP_FR:20-23141','2023-14-1',100),
('civant_default','BOAMP_FR:20-23148','2023-148',100),
('civant_default','BOAMP_FR:20-23151','2023151',100),
('civant_default','BOAMP_FR:20-23182','2023-182',100),
('civant_default','BOAMP_FR:20-23193','2023-193',100),
('civant_default','BOAMP_FR:20-23212','2023212',100),
('civant_default','BOAMP_FR:20-23214','2023214',100),
('civant_default','BOAMP_FR:20-23228','2023228',100),
('civant_default','BOAMP_FR:20-23237','202323-7',100),
('civant_default','BOAMP_FR:20-23283','2023283',100),
('civant_default','BOAMP_FR:20-2333','2023 33',100),
('civant_default','BOAMP_FR:20-23333','2023333',100),
('civant_default','BOAMP_FR:20-23388','2023388',100),
('civant_default','BOAMP_FR:20-23392','2023392',100),
('civant_default','BOAMP_FR:20-23403','2023403',100),
('civant_default','BOAMP_FR:20-23429','2023429',100),
('civant_default','BOAMP_FR:20-23437','2023437',100),
('civant_default','BOAMP_FR:20-23443','2023443',100),
('civant_default','BOAMP_FR:20-23618','2023618',100),
('civant_default','BOAMP_FR:20-2365','202365',100),
('civant_default','BOAMP_FR:20-23746','2023746',100),
('civant_default','BOAMP_FR:20-2377','202377',100),
('civant_default','BOAMP_FR:20-2388','202388',100),
('civant_default','BOAMP_FR:20-2395','202395',100),
('civant_default','BOAMP_FR:20-23981','2023981',100),
('civant_default','BOAMP_FR:20-24009','2024 009',100),
('civant_default','BOAMP_FR:20-2405','2024-05',100),
('civant_default','BOAMP_FR:20-2411','202411',100),
('civant_default','BOAMP_FR:20-24158','2024-158',100),
('civant_default','BOAMP_FR:20-2417','2024_17',100),
('civant_default','BOAMP_FR:20-2418','2024_18',100),
('civant_default','BOAMP_FR:20-24186','2024-186',100),
('civant_default','BOAMP_FR:20-24196','2024196',100),
('civant_default','BOAMP_FR:20-2424','2.02424',100),
('civant_default','BOAMP_FR:20-24260','2024260',100),
('civant_default','BOAMP_FR:20-2427','202427',100),
('civant_default','BOAMP_FR:20-24283','2024283',100),
('civant_default','BOAMP_FR:20-24306','2024306',100),
('civant_default','BOAMP_FR:20-2433','2024_33',100),
('civant_default','BOAMP_FR:20-24341','2024341',100),
('civant_default','BOAMP_FR:20-24342','2024342',100),
('civant_default','BOAMP_FR:20-24345','2024345',100),
('civant_default','BOAMP_FR:20-2435','2024-35',100),
('civant_default','BOAMP_FR:20-24355','2024355',100),
('civant_default','BOAMP_FR:20-2439','2024-39',100),
('civant_default','BOAMP_FR:20-24395','2024395',100),
('civant_default','BOAMP_FR:20-24401','2024-4-01',100),
('civant_default','BOAMP_FR:20-24414','2024414',100),
('civant_default','BOAMP_FR:20-24422','2024422',100),
('civant_default','BOAMP_FR:20-2446','2024-46',100),
('civant_default','BOAMP_FR:20-24488','2024-488',100),
('civant_default','BOAMP_FR:20-24500','2024_5_00',100),
('civant_default','BOAMP_FR:20-24564','2024564',100),
('civant_default','BOAMP_FR:20-24567','2024-567',100),
('civant_default','BOAMP_FR:20-24581','2024581',100),
('civant_default','BOAMP_FR:20-2459','2024-59',100),
('civant_default','BOAMP_FR:20-24599','2024-59-9',100),
('civant_default','BOAMP_FR:20-246','2024-6',100),
('civant_default','BOAMP_FR:20-24607','2024-607',100),
('civant_default','BOAMP_FR:20-24620','2024-620',100),
('civant_default','BOAMP_FR:20-24640','2024-640',100),
('civant_default','BOAMP_FR:20-24664','2024-664',100),
('civant_default','BOAMP_FR:20-24667','2024-667',100),
('civant_default','BOAMP_FR:20-24670','2024-670',100),
('civant_default','BOAMP_FR:20-24680','2024-680',100),
('civant_default','BOAMP_FR:20-24700','2024-7-00',100),
('civant_default','BOAMP_FR:20-2471','2024-71',100),
('civant_default','BOAMP_FR:20-24739','2024-739',100),
('civant_default','BOAMP_FR:20-24742','2024-742',100),
('civant_default','BOAMP_FR:20-2479','2024-79',100),
('civant_default','BOAMP_FR:20-248','20248',100),
('civant_default','BOAMP_FR:20-2483','2024-83',100),
('civant_default','BOAMP_FR:20-2485','2024-85',100),
('civant_default','BOAMP_FR:20-24868','2024868',100),
('civant_default','BOAMP_FR:20-24949','2024949',100),
('civant_default','BOAMP_FR:20-24955','2024955',100),
('civant_default','BOAMP_FR:20-24980','2024-980',100),
('civant_default','BOAMP_FR:20-24989','2024_989',100),
('civant_default','BOAMP_FR:20-25028','2025_028',100),
('civant_default','BOAMP_FR:20-25042','2025-042',100),
('civant_default','BOAMP_FR:20-25089','2025089',100),
('civant_default','BOAMP_FR:20-25096','2025096',100),
('civant_default','BOAMP_FR:20-25109','2025109',100),
('civant_default','BOAMP_FR:20-25126','2025126',100),
('civant_default','BOAMP_FR:20-25143','2025 14 3',100),
('civant_default','BOAMP_FR:20-25168','2025168',100),
('civant_default','BOAMP_FR:20-25171','2025171',100),
('civant_default','BOAMP_FR:20-25201','202520-1',100),
('civant_default','BOAMP_FR:20-25224','2025224',100),
('civant_default','BOAMP_FR:20-25250','2025250',100),
('civant_default','BOAMP_FR:20-25256','2025256',100),
('civant_default','BOAMP_FR:20-25283','2025283',100),
('civant_default','BOAMP_FR:20-25339','2025339',100),
('civant_default','BOAMP_FR:20-25355','2025355',100),
('civant_default','BOAMP_FR:20-25358','2025358',100),
('civant_default','BOAMP_FR:20-25360','2025360',100),
('civant_default','BOAMP_FR:20-25390','2025390',100),
('civant_default','BOAMP_FR:20-25402','2025402',100),
('civant_default','BOAMP_FR:20-25416','2025416',100),
('civant_default','BOAMP_FR:20-25421','2025421',100),
('civant_default','BOAMP_FR:20-25424','2025424',100),
('civant_default','BOAMP_FR:20-2547','202547',100),
('civant_default','BOAMP_FR:20-2552','202552',100),
('civant_default','BOAMP_FR:20-2554','202554',100),
('civant_default','BOAMP_FR:20-2555','202555',100),
('civant_default','BOAMP_FR:20-2556','202556',100),
('civant_default','BOAMP_FR:20-2561','202561',100),
('civant_default','BOAMP_FR:20-2562','2025-62',100),
('civant_default','BOAMP_FR:20-2563','2025-63',100),
('civant_default','BOAMP_FR:20-25648','2025648',100),
('civant_default','BOAMP_FR:20-25649','2025649',100),
('civant_default','BOAMP_FR:20-25662','2025662',100),
('civant_default','BOAMP_FR:20-25699','2025699',100),
('civant_default','BOAMP_FR:20-2570','2025-70',100),
('civant_default','BOAMP_FR:20-25701','2025-701',100),
('civant_default','BOAMP_FR:20-25757','2025757',100),
('civant_default','BOAMP_FR:20-25805','2025805',100),
('civant_default','BOAMP_FR:20-25820','2025820',100),
('civant_default','BOAMP_FR:20-25909','2025909',100),
('civant_default','BOAMP_FR:20-26003','2026003',100),
('civant_default','BOAMP_FR:20-2602','2026-02',100),
('civant_default','BOAMP_FR:20-26271','2026271',100),
('civant_default','BOAMP_FR:20-2629','202629',100),
('civant_default','BOAMP_FR:20-264','20264',100),
('civant_default','BOAMP_FR:20-2683','202683',100),
('civant_default','BOAMP_FR:20-45274','20201000006991',86),
('civant_default','BOAMP_FR:20-54881','2020C049',83),
('civant_default','BOAMP_FR:20-78721','2020096',86),
('civant_default','BOAMP_FR:20-90659','2020AO20001',86),
('civant_default','BOAMP_FR:20-91030','20202011',86),
('civant_default','BOAMP_FR:20-96167','20200000021688',86),
('civant_default','BOAMP_FR:20-96659','2020200227',86),
('civant_default','BOAMP_FR:21-104811','2020M2000893',86),
('civant_default','BOAMP_FR:21-108304','2021210402',83),
('civant_default','BOAMP_FR:21-109894','202100PF21-058',83),
('civant_default','BOAMP_FR:21-111330','2021M2100918',86),
('civant_default','BOAMP_FR:21-11147','20212007',83),
('civant_default','BOAMP_FR:21-111953','2021M2100929',86),
('civant_default','BOAMP_FR:21-114215','2021300253',86),
('civant_default','BOAMP_FR:21-119002','202012031410',86),
('civant_default','BOAMP_FR:21-119345','2021V0D0032ST',86),
('civant_default','BOAMP_FR:21-124332','2021023-2021',86),
('civant_default','BOAMP_FR:21-131804','202120210518',83),
('civant_default','BOAMP_FR:21-133481','2021095',83),
('civant_default','BOAMP_FR:21-134866','2021M210403',86),
('civant_default','BOAMP_FR:21-134971','20210012',86),
('civant_default','BOAMP_FR:21-135995','2021_020_M_MER',86),
('civant_default','BOAMP_FR:21-136336','20210173',86),
('civant_default','BOAMP_FR:21-143159','2021D113',86),
('civant_default','BOAMP_FR:21-1534','211534',100),
('civant_default','BOAMP_FR:21-1542','211542',100),
('civant_default','BOAMP_FR:21-18350','202120035',86),
('civant_default','BOAMP_FR:21-18531','202000PF10-123',86),
('civant_default','BOAMP_FR:21-21007','2021300398',86),
('civant_default','BOAMP_FR:21-21667','2020161',86),
('civant_default','BOAMP_FR:21-2714','2020920',86),
('civant_default','BOAMP_FR:21-2916','2020508452',86),
('civant_default','BOAMP_FR:21-31339','202',83),
('civant_default','BOAMP_FR:21-33856','2021508645',83),
('civant_default','BOAMP_FR:21-346','21-346',100),
('civant_default','BOAMP_FR:21-39841','2021M1998A',86),
('civant_default','BOAMP_FR:21-39843','20212031',83),
('civant_default','BOAMP_FR:21-43119','202121063',86),
('civant_default','BOAMP_FR:21-48769','21-214004',86),
('civant_default','BOAMP_FR:21-52968','2021M2903A',86),
('civant_default','BOAMP_FR:21-55312','2021508869',86),
('civant_default','BOAMP_FR:21-56314','2021M2100430',86),
('civant_default','BOAMP_FR:21-57590','2021301977',86),
('civant_default','BOAMP_FR:21-577','21577',100),
('civant_default','BOAMP_FR:21-60964','2021M2200283',83),
('civant_default','BOAMP_FR:21-63660','2020SO1902',83),
('civant_default','BOAMP_FR:21-64052','2021506',86),
('civant_default','BOAMP_FR:21-66547','202121039',83),
('civant_default','BOAMP_FR:21-6834','2021',86),
('civant_default','BOAMP_FR:21-69508','2021M210000275',86),
('civant_default','BOAMP_FR:21-71626','20212101',86),
('civant_default','BOAMP_FR:21-72609','202121MA005',86),
('civant_default','BOAMP_FR:21-837','21837',100),
('civant_default','BOAMP_FR:21-85556','2021ENVPAV2',86),
('civant_default','BOAMP_FR:21-857','21857',100),
('civant_default','BOAMP_FR:21-87259','2021MAPA',86),
('civant_default','BOAMP_FR:21-9498','202120M20',86),
('civant_default','BOAMP_FR:21-961','21961',100),
('civant_default','BOAMP_FR:21-963','21963',100),
('civant_default','BOAMP_FR:21-98621','2021509294',86),
('civant_default','BOAMP_FR:21-99753','2021M3022A',86),
('civant_default','BOAMP_FR:21-99992','2021052',86),
('civant_default','BOAMP_FR:22-11507','2022K21225',86),
('civant_default','BOAMP_FR:22-124','22-124',100),
('civant_default','BOAMP_FR:22-165','22-165',100),
('civant_default','BOAMP_FR:22-200','22-200',100),
('civant_default','BOAMP_FR:22-250','22-250',100),
('civant_default','BOAMP_FR:22-26646','202121M0569',83),
('civant_default','BOAMP_FR:22-35374','202222023',86),
('civant_default','BOAMP_FR:22-43742','22-43742',100),
('civant_default','BOAMP_FR:22-55893','2022M2200267',86),
('civant_default','BOAMP_FR:22-57423','2022N3741A',83),
('civant_default','BOAMP_FR:22-664','22664',100),
('civant_default','BOAMP_FR:22-7','227',100),
('civant_default','BOAMP_FR:22-702','22702',100),
('civant_default','BOAMP_FR:22-7944','202220210928',83),
('civant_default','BOAMP_FR:22-8162','228162',100)
;

with updated as (
  update public.award_fact_fr af
  set
    duration_months = case
      when af.framework_evidence->>'fr_duration_months_source' = 'decp_fr' then null
      else af.duration_months
    end,
    end_date = case
      when af.framework_evidence->>'fr_end_date_source' = 'award_date_plus_duration_months_decp_fr' then null
      else af.end_date
    end,
    framework_evidence = jsonb_strip_nulls(
      coalesce(af.framework_evidence, '{}'::jsonb)
        - 'fr_decp_dataset'
        - 'fr_decp_id'
        - 'fr_decp_id_base'
        - 'fr_decp_source'
        - 'fr_decp_match_score'
        - 'fr_decp_acheteur_id'
        - 'fr_duration_months_source'
        - 'fr_end_date_source'
    )
  from tmp_fr_decp_rollback_targets t
  where af.tenant_id = t.tenant_id
    and af.award_canonical_id = t.award_canonical_id
    and coalesce(af.framework_evidence->>'fr_decp_id','') = coalesce(t.decp_id,'')
    and coalesce((af.framework_evidence->>'fr_decp_match_score')::int, -1) = coalesce(t.decp_match_score, -1)
  returning af.tenant_id, af.award_canonical_id
)
select count(*) as rollback_rows from updated;

commit;

-- Validation:
-- select count(*) from public.award_fact_fr
-- where tenant_id='civant_default'
--   and award_date >= date '2020-01-01'
--   and framework_evidence ? 'fr_decp_match_score';
