name: "ETenders IE Incremental Sync"

on:
  schedule:
    # Daily at 05:15 UTC.
    - cron: "15 5 * * *"
  workflow_dispatch:
    inputs:
      tenant_id:
        description: "Tenant id (defaults to civant_default)"
        required: false
        default: "civant_default"
      start_date:
        description: "Optional start date (YYYY-MM-DD). Leave blank to use stored cursor."
        required: false
        default: ""
      dry_run:
        description: "Dry run (true/false)"
        required: false
        default: "false"

concurrency:
  group: "etenders-ie-incremental"
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      # Stored in GitHub repo secrets. Must include sslmode=require.
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
      # Optional. If not set, workflow_dispatch default is used; schedule defaults to civant_default.
      CIVANT_TENANT_ID: ${{ secrets.CIVANT_TENANT_ID }}
      PSQL_BIN: psql

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install psql
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Run eTenders incremental sync
        shell: bash
        run: |
          set -euo pipefail

          # Determine tenant + args.
          TENANT_ID="${CIVANT_TENANT_ID:-${{ github.event.inputs.tenant_id || 'civant_default' }}}"
          START_DATE="${{ github.event.inputs.start_date || '' }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"

          if [[ -z "${SUPABASE_DB_URL:-}" ]]; then
            echo "ERROR: SUPABASE_DB_URL secret is required."
            exit 1
          fi

          ./scripts/rollout-etenders-ie-incremental.sh "${TENANT_ID}" "${START_DATE}" "${DRY_RUN}"
