name: "Canonical Reconciliation Sweep"

on:
  schedule:
    # Daily at 07:20 UTC, after country connector windows.
    - cron: "20 7 * * *"
  workflow_dispatch:
    inputs:
      tenant_id:
        description: "Tenant id (defaults to civant_default)"
        required: false
        default: "civant_default"
      countries:
        description: "Comma-separated ISO2 countries"
        required: false
        default: "IE,FR,ES"
      backfill_limit:
        description: "Rows to backfill (0 = full tenant scan)"
        required: false
        default: "0"
      recon_limit:
        description: "TED notices to reconcile per country (0 = full country scan)"
        required: false
        default: "0"
      apply:
        description: "Apply relinks (true/false)"
        required: false
        default: "true"

concurrency:
  group: "canonical-reconcile-sweep"
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  sweep:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    env:
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
      CIVANT_TENANT_ID: ${{ secrets.CIVANT_TENANT_ID }}
      DISPATCH_TENANT_ID: ${{ github.event.inputs.tenant_id }}
      DISPATCH_COUNTRIES: ${{ github.event.inputs.countries }}
      DISPATCH_BACKFILL_LIMIT: ${{ github.event.inputs.backfill_limit }}
      DISPATCH_RECON_LIMIT: ${{ github.event.inputs.recon_limit }}
      DISPATCH_APPLY: ${{ github.event.inputs.apply }}
      PSQL_BIN: psql
      BACKFILL_BATCH_SIZE: "10000"
      RECON_BATCH_SIZE: "20"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install psql
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Run canonical reconciliation sweep
        shell: bash
        run: |
          set -euo pipefail
          export PGOPTIONS='-c statement_timeout=30min'
          TENANT_ID="${CIVANT_TENANT_ID:-${DISPATCH_TENANT_ID:-civant_default}}"
          COUNTRIES="${DISPATCH_COUNTRIES:-IE,FR,ES}"
          BACKFILL_LIMIT="${DISPATCH_BACKFILL_LIMIT:-0}"
          RECON_LIMIT="${DISPATCH_RECON_LIMIT:-0}"
          APPLY="${DISPATCH_APPLY:-true}"
          if [[ -z "${SUPABASE_DB_URL:-}" ]]; then
            echo "ERROR: SUPABASE_DB_URL secret is required."
            exit 1
          fi
          if [[ "${SUPABASE_DB_URL}" != *"sslmode=require"* ]]; then
            echo "ERROR: SUPABASE_DB_URL must include sslmode=require."
            exit 1
          fi
          ./scripts/rollout-canonical-primary-source-reconcile.sh \
            "${TENANT_ID}" \
            "${BACKFILL_LIMIT}" \
            "${RECON_LIMIT}" \
            "${APPLY}" \
            "${COUNTRIES}"
