name: "Predictive Engine Nightly Full V1"

on:
  schedule:
    # Daily at 02:35 UTC.
    - cron: "35 2 * * *"
  workflow_dispatch:
    inputs:
      tenant_id:
        description: "Tenant id (defaults to civant_default)"
        required: false
        default: "civant_default"
      max_pairs:
        description: "Max buyer/category pairs"
        required: false
        default: "25000"

concurrency:
  # Shared group across predictive workflows to avoid deadlocks from concurrent engine runs.
  group: "predictive-engine-v1-serialized"
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    env:
      # Default to pooler/default secret for runner network compatibility.
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_POOLER_URL || secrets.SUPABASE_DB_URL }}
      # Optional direct URL; used only when preflight succeeds.
      SUPABASE_DB_DIRECT_URL: ${{ secrets.SUPABASE_DB_DIRECT_URL }}
      CIVANT_TENANT_ID: ${{ secrets.CIVANT_TENANT_ID }}
      DISPATCH_TENANT_ID: ${{ github.event.inputs.tenant_id }}
      DISPATCH_MAX_PAIRS: ${{ github.event.inputs.max_pairs }}
      PSQL_BIN: psql

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install psql
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Run nightly full predictive compute
        shell: bash
        run: |
          set -euo pipefail

          TENANT_ID="${CIVANT_TENANT_ID:-${DISPATCH_TENANT_ID:-civant_default}}"
          MAX_PAIRS="${DISPATCH_MAX_PAIRS:-25000}"

          if [[ -z "${SUPABASE_DB_URL:-}" ]]; then
            echo "ERROR: SUPABASE_DB_URL secret is required."
            exit 1
          fi

          if [[ -n "${SUPABASE_DB_DIRECT_URL:-}" ]]; then
            if psql "${SUPABASE_DB_DIRECT_URL}" -v ON_ERROR_STOP=1 -P pager=off -qtA -c "select 1;" >/dev/null 2>&1; then
              echo "INFO: using SUPABASE_DB_DIRECT_URL after successful preflight."
              export SUPABASE_DB_URL="${SUPABASE_DB_DIRECT_URL}"
            else
              echo "WARN: SUPABASE_DB_DIRECT_URL preflight failed; using SUPABASE_DB_URL fallback."
            fi
          fi

          for attempt in 1 2; do
            if ./scripts/rollout-predictive-engine-v1.sh "${TENANT_ID}" "full" "" "${MAX_PAIRS}" "true" "v1.0.0"; then
              exit 0
            fi
            echo "WARN: predictive nightly attempt ${attempt}/2 failed."
            if [[ "${attempt}" -lt 2 ]]; then
              sleep 30
            fi
          done

          echo "ERROR: predictive nightly failed after 2 attempts."
          exit 1
