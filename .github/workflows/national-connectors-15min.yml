name: "National Connectors 15m Monitor"

on:
  schedule:
    # Every 15 minutes (UTC).
    - cron: "*/15 * * * *"
  workflow_dispatch:
    inputs:
      tenant_id:
        description: "Tenant id (defaults to civant_default)"
        required: false
        default: "civant_default"
      connector:
        description: "Optional single connector (boamp|etenders|placsp). Leave blank for all."
        required: false
        default: ""
      force_heavy:
        description: "Force heavy sync even if detector finds no changes (true/false)"
        required: false
        default: "false"

permissions:
  contents: read

jobs:
  monitor-and-sync:
    if: github.event_name != 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        connector: [boamp, etenders, placsp]

    concurrency:
      group: "national-15m-${{ matrix.connector }}"
      cancel-in-progress: false

    if: ${{ github.event_name == 'schedule' || github.event.inputs.connector == '' || github.event.inputs.connector == matrix.connector }}

    env:
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_POOLER_URL || secrets.SUPABASE_DB_URL }}
      CIVANT_TENANT_ID: ${{ secrets.CIVANT_TENANT_ID }}
      DISPATCH_TENANT_ID: ${{ github.event.inputs.tenant_id }}
      DISPATCH_FORCE_HEAVY: ${{ github.event.inputs.force_heavy }}
      API_BASE_URL: https://civantapp.vercel.app
      APP_ID: civantapp
      PSQL_BIN: psql

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install psql
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Validate DB URL
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${SUPABASE_DB_URL:-}" ]]; then
            echo "ERROR: SUPABASE_DB_URL secret is required."
            exit 1
          fi
          if [[ "${SUPABASE_DB_URL}" != *"sslmode=require"* ]]; then
            if [[ "${SUPABASE_DB_URL}" == *"?"* ]]; then
              SUPABASE_DB_URL="${SUPABASE_DB_URL}&sslmode=require"
            else
              SUPABASE_DB_URL="${SUPABASE_DB_URL}?sslmode=require"
            fi
          fi
          echo "SUPABASE_DB_URL=${SUPABASE_DB_URL}" >> "$GITHUB_ENV"

      - name: Run detector + conditional heavy sync (${{ matrix.connector }})
        shell: bash
        run: |
          set -euo pipefail
          TENANT_ID="${CIVANT_TENANT_ID:-${DISPATCH_TENANT_ID:-civant_default}}"
          FORCE_HEAVY="${DISPATCH_FORCE_HEAVY:-false}"

          # Retry once for transient source/API errors.
          for attempt in 1 2; do
            if FORCE_HEAVY="${FORCE_HEAVY}" ./scripts/run-national-connector-check-and-sync.sh "${{ matrix.connector }}" "${TENANT_ID}"; then
              exit 0
            fi
            echo "WARN: connector=${{ matrix.connector }} attempt=${attempt}/2 failed."
            if [[ "${attempt}" -lt 2 ]]; then
              sleep 20
            fi
          done

          echo "ERROR: connector=${{ matrix.connector }} failed after retries."
          exit 1
